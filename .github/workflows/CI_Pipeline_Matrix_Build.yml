name: CI Pipeline Matrix Build
on: [workflow_dispatch,push]
jobs:
  build_frontend:
   runs-on: ubuntu-latest
   needs: deploying_backend_accounts_microservice
   steps:
     - name: checkout frontend code
       uses: actions/checkout@v5
     - name: Set up Node 22
       uses: actions/setup-node@v6
       with:
         node-version: 22
     - name: Building React Frontend
       working-directory: ./frontend
       run: |
        npm ci
        npm run build
     - name: Build frontend Docker image
       run: docker build -t thevikashpratapsingh/colleger_frontend:latest ./frontend
     - name: Login to the Docker Hub
       run: echo "${{ secrets.DOCKER_PASSWORD }}" | docker login -u "${{ secrets.DOCKER_USERNAME }}" --password-stdin
     - name: Push the frontend image
       run: docker push thevikashpratapsingh/colleger_frontend:latest 

  build_backend_microservices:
   runs-on: ubuntu-latest
   strategy:
    matrix:
     service: [accounts-service, caretaker-service, charity-service, student-service, teacher-service]
   steps:
     - name: Checking out the code
       uses: actions/checkout@v5
     - name: Setting up the jdk 
       uses: actions/setup-java@v5
       with:
        distribution: 'temurin' 
        java-version: '21'
     - name: Build ${{ matrix.service }} JAR
       working-directory: ./backend/${{ matrix.service }} 
       run: mvn clean package -DskipTests
     - name: Build ${{ matrix.service }} Docker image
       run: docker build -t thevikashpratapsingh/colleger_${{ matrix.service }}:latest ./backend/${{ matrix.service }}
     - name: Login to Docker hub of thevikashpratapsingh account
       run: echo "${{ secrets.DOCKER_PASSWORD }}" | docker login -u "${{ secrets.DOCKER_USERNAME }}" --password-stdin
     - name: Push image of ${{ matrix.service }} 
       run: docker push thevikashpratapsingh/colleger_${{ matrix.service }}:latest